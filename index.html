<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mi Plan | 4Elements</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@300;400;500;600&family=Playfair+Display:ital,wght@0,400;0,700;1,400&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'wellness-primary': '#418b89', 
                        'wellness-accent': '#a68177',  
                        'wellness-bg': '#ece6dd',      
                        'wellness-dark': '#412814',
                    },
                    fontFamily: {
                        'sans': ['Montserrat', 'sans-serif'], 
                        'serif': ['Playfair Display', 'serif'], 
                    }
                }
            }
        }
    </script>
    <style>
        body { background-color: #ece6dd; color: #412814; }
        .loader { border-top-color: #418b89; -webkit-animation: spinner 1.5s linear infinite; animation: spinner 1.5s linear infinite; }
        @keyframes spinner { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .hidden-content { display: none; }
        .fade-in { animation: fadeIn 0.8s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .product-card { transition: all 0.3s ease; }
        .product-card:hover { transform: translateY(-5px); box-shadow: 0 10px 20px rgba(65, 139, 137, 0.15); }
    </style>
</head>
<body class="font-sans antialiased h-screen flex flex-col">

    <div id="login-screen" class="fixed inset-0 z-[100] bg-wellness-bg flex flex-col items-center justify-center p-6 text-center">
        <div class="max-w-md w-full bg-white p-10 rounded-[2.5rem] shadow-xl border-t-8 border-wellness-primary">
            <div class="mb-8">
                <span class="block text-2xl tracking-[0.4em] font-light text-wellness-primary">4ELEMENTS</span>
                <span class="block text-[8px] tracking-[0.3em] font-bold text-wellness-accent uppercase mt-2">Área Paciente</span>
            </div>
            <p class="text-sm opacity-60 mb-8 font-light">Introduce tu código personal.</p>
            <div class="space-y-4 relative">
                <input type="password" id="pass-input" placeholder="Tu código..." 
                    class="w-full bg-gray-50 border border-gray-200 rounded-xl px-4 py-3 text-center tracking-widest text-wellness-primary focus:outline-none focus:border-wellness-primary transition-colors">
                <button onclick="verificarCodigo()" id="btn-login"
                    class="w-full bg-wellness-primary text-white py-4 rounded-xl font-bold text-xs uppercase tracking-[0.2em] shadow-lg hover:bg-[#367270] transition-all">
                    ENTRAR
                </button>
                <div id="loading" class="hidden absolute inset-0 bg-white/80 flex items-center justify-center rounded-xl">
                    <div class="loader ease-linear rounded-full border-4 border-t-4 border-gray-200 h-6 w-6"></div>
                </div>
                <p id="error-msg" class="text-red-400 text-xs font-bold hidden mt-2">Código no encontrado.</p>
            </div>
        </div>
    </div>

    <div id="app-content" class="hidden-content min-h-screen pb-20">
        
        <nav class="bg-white/90 backdrop-blur-md sticky top-0 z-50 border-b border-wellness-primary/10">
            <div class="max-w-5xl mx-auto px-6 py-4 flex justify-between items-center">
                <div class="text-center md:text-left">
                    <span class="block text-lg tracking-[0.3em] font-light text-wellness-primary">4ELEMENTS</span>
                </div>
                <button onclick="location.reload()" class="text-xs font-bold text-gray-400 hover:text-wellness-primary uppercase tracking-widest">
                    <i class="fa-solid fa-power-off"></i> Salir
                </button>
            </div>
        </nav>

        <main class="max-w-3xl mx-auto px-6 py-10 space-y-16 fade-in">
            
            <section class="space-y-6">
                <header class="text-center space-y-2">
                    <p class="text-wellness-accent font-bold text-xs uppercase tracking-[0.2em]">Tu Evolución</p>
                    <h1 class="text-3xl md:text-4xl font-serif text-wellness-primary">Hola, <span id="user-name">...</span></h1>
                </header>

                <div class="bg-white rounded-[2rem] shadow-lg overflow-hidden border border-wellness-primary/20 relative">
                    <div class="absolute top-4 right-4 bg-wellness-accent text-white text-[10px] font-bold px-3 py-1 rounded-full uppercase tracking-widest animate-pulse">
                        Activo
                    </div>
                    <div class="p-8 text-center">
                        <div class="w-14 h-14 bg-wellness-bg rounded-full flex items-center justify-center mx-auto text-wellness-primary text-xl mb-4">
                            <i class="fa-solid fa-file-medical"></i>
                        </div>
                        <h2 class="font-serif text-2xl text-wellness-dark mb-1" id="active-title">...</h2>
                        <p class="text-[10px] uppercase text-gray-400 font-bold tracking-widest mb-6" id="active-date">...</p>
                        
                        <a id="active-pdf" href="#" target="_blank" class="w-full block bg-wellness-primary hover:bg-[#367270] text-white py-4 rounded-xl text-xs font-bold uppercase tracking-widest shadow-lg transition-all">
                            <i class="fa-regular fa-file-pdf mr-2"></i> Ver Mi Plan Nutricional
                        </a>
                    </div>
                </div>
            </section>

            <section class="space-y-6">
                <div class="flex items-center gap-4">
                    <div class="w-10 h-10 rounded-full bg-wellness-accent/10 flex items-center justify-center text-wellness-accent">
                        <i class="fa-solid fa-scale-balanced"></i>
                    </div>
                    <h3 class="font-serif text-2xl text-wellness-dark">Tus Reglas de Oro</h3>
                </div>

                <div class="grid md:grid-cols-2 gap-4">
                    <div class="bg-white p-6 rounded-[1.5rem] border-l-4 border-wellness-primary shadow-sm">
                        <h4 class="font-bold text-wellness-primary text-xs uppercase tracking-widest mb-4">Tu Base (Sí)</h4>
                        <ul class="space-y-3 text-sm opacity-80">
                            <li class="flex gap-3"><i class="fa-solid fa-check text-wellness-primary"></i> <span><strong>Proteínas ilimitadas:</strong> Carnes, pescado, huevo, sepia, pulpo.</span></li>
                            <li class="flex gap-3"><i class="fa-solid fa-check text-wellness-primary"></i> <span><strong>Guarnición:</strong> 1/4 del plato (ensalada, verdura, setas).</span></li>
                            <li class="flex gap-3"><i class="fa-solid fa-check text-wellness-primary"></i> <span><strong>Cocción:</strong> Plancha, vapor, horno (sin rebozados).</span></li>
                        </ul>
                    </div>
                    
                    <div class="bg-white p-6 rounded-[1.5rem] border-l-4 border-wellness-accent shadow-sm">
                        <h4 class="font-bold text-wellness-accent text-xs uppercase tracking-widest mb-4">A Evitar (No)</h4>
                        <ul class="space-y-3 text-sm opacity-80">
                            <li class="flex gap-3"><i class="fa-solid fa-xmark text-wellness-accent"></i> <span>Azúcar, bollería y pastelería.</span></li>
                            <li class="flex gap-3"><i class="fa-solid fa-xmark text-wellness-accent"></i> <span>Refrescos (sí a sacarina/light).</span></li>
                            <li class="flex gap-3"><i class="fa-solid fa-xmark text-wellness-accent"></i> <span>Alcohol.</span></li>
                            <li class="flex gap-3"><i class="fa-solid fa-circle-exclamation text-wellness-accent"></i> <span><strong>Fruta:</strong> Solo 1 ración al día.</span></li>
                        </ul>
                    </div>
                </div>
            </section>

            <section class="space-y-6">
                <div class="flex items-center justify-between">
                    <div class="flex items-center gap-4">
                        <div class="w-10 h-10 rounded-full bg-wellness-primary/10 flex items-center justify-center text-wellness-primary">
                            <i class="fa-solid fa-bag-shopping"></i>
                        </div>
                        <h3 class="font-serif text-2xl text-wellness-dark">Farmacia 4 Elements</h3>
                    </div>
                </div>

                <div class="grid sm:grid-cols-2 gap-4">
                    <div class="product-card bg-white p-6 rounded-[2rem] shadow-sm border border-gray-100 flex flex-col justify-between">
                        <div>
                            <h4 class="font-serif text-lg text-wellness-dark mb-2">Método PronoKal®</h4>
                            <p class="text-xs text-gray-500 mb-4">Tratamiento médico bajo supervisión. Reposición de productos.</p>
                        </div>
                        <a href="https://wa.me/34674201432?text=Hola Dra. Macías, me gustaría recibir información para iniciar o reponer productos del Método PronoKal." target="_blank" 
                           class="w-full py-3 rounded-full border border-wellness-primary text-wellness-primary text-[10px] font-bold uppercase tracking-widest hover:bg-wellness-primary hover:text-white transition-colors text-center block">
                           Contactar Doctora
                        </a>
                    </div>

                    <div class="product-card bg-white p-6 rounded-[2rem] shadow-sm border border-gray-100 flex flex-col justify-between">
                        <div>
                            <h4 class="font-serif text-lg text-wellness-dark mb-2">Suplementación</h4>
                            <p class="text-xs text-gray-500 mb-4">Vitaminas, Omega 3 y Drenantes específicos para tu plan.</p>
                        </div>
                        <a href="https://wa.me/34674201432?text=Hola Dra. Macías, necesito reponer mi pauta de micronutrición / suplementos." target="_blank" 
                           class="w-full py-3 rounded-full border border-wellness-primary text-wellness-primary text-[10px] font-bold uppercase tracking-widest hover:bg-wellness-primary hover:text-white transition-colors text-center block">
                           Pedir Reposición
                        </a>
                    </div>
                    
                    <div class="product-card bg-white p-6 rounded-[2rem] shadow-sm border border-gray-100 sm:col-span-2 flex flex-col sm:flex-row items-center gap-6">
                        <div class="w-12 h-12 bg-orange-50 rounded-full flex items-center justify-center text-orange-400 shrink-0">
                            <i class="fa-solid fa-box-open"></i>
                        </div>
                        <div class="flex-1 text-center sm:text-left">
                            <h4 class="font-serif text-lg text-wellness-dark">Stock en Clínica</h4>
                            <p class="text-xs text-gray-500 mt-1">Consulta los snacks y batidos disponibles para recogida inmediata.</p>
                        </div>
                        <a href="https://wa.me/34674201432?text=Hola Dra. Macías, ¿qué snacks proteicos tenéis disponibles actualmente en stock?" target="_blank" 
                           class="px-6 py-3 rounded-full bg-wellness-accent text-white text-[10px] font-bold uppercase tracking-widest hover:bg-[#8f6d65] transition-colors shadow-lg">
                           Consultar Stock
                        </a>
                    </div>
                </div>
            </section>

        </main>
    </div>

    <script>
        // =================================================================
        // HE CORREGIDO ESTA LÍNEA (AÑADIDAS LAS COMILLAS):
        // =================================================================
        const URL_EXCEL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vTtDe-3Hsg6FSo7SewPSgDvH5DpCOf9TF6rC4eisgrBoopjbLxSYLsX-lbWuAtlzTtadxzfsO-uic3k/pub?output=csv";
        // =================================================================

        function verificarCodigo() {
            const inputCode = document.getElementById('pass-input').value.trim().toUpperCase();
            const btn = document.getElementById('btn-login');
            const loading = document.getElementById('loading');
            const errorMsg = document.getElementById('error-msg');

            btn.classList.add('opacity-50', 'pointer-events-none');
            loading.classList.remove('hidden');
            errorMsg.classList.add('hidden');

            Papa.parse(URL_EXCEL, {
                download: true,
                header: true,
                complete: function(results) {
                    const datos = results.data;
                    // Buscamos todas las coincidencias
                    const historialPaciente = datos.filter(row => 
                        row.CODIGO && row.CODIGO.trim().toUpperCase() === inputCode
                    );

                    if (historialPaciente.length > 0) {
                        // Cogemos SIEMPRE la última fila que hayas añadido (la más nueva)
                        const ultimoPlan = historialPaciente[historialPaciente.length - 1];
                        renderizarPaciente(ultimoPlan);
                    } else {
                        loading.classList.add('hidden');
                        btn.classList.remove('opacity-50', 'pointer-events-none');
                        errorMsg.classList.remove('hidden');
                    }
                },
                error: function() {
                    loading.classList.add('hidden');
                    errorMsg.innerText = "Error de conexión";
                    errorMsg.classList.remove('hidden');
                }
            });
        }

        function renderizarPaciente(data) {
            // Rellenar datos
            document.getElementById('user-name').innerText = data.NOMBRE;
            document.getElementById('active-title').innerText = data.TITULO;
            document.getElementById('active-date').innerText = data.FECHA;
            document.getElementById('active-pdf').href = data.PDF;

            // Abrir puerta
            document.getElementById('login-screen').style.opacity = '0';
            setTimeout(() => {
                document.getElementById('login-screen').style.display = 'none';
                document.getElementById('app-content').style.display = 'block';
            }, 500);
        }

        document.getElementById("pass-input").addEventListener("keypress", function(e) {
            if (e.key === "Enter") verificarCodigo();
        });
    </script>
</body>
</html>
